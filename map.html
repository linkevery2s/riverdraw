<!DOCTYPE HTML>
<html lang="ja">
<title>マップ</title>

<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
  <meta charset="UTF-8" name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- deck.gl standalone bundle -->
  <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style type="text/css">
    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #container {
      width: 100%;
      height: 100%;
    }
  </style>

</head>

<body>

  <div id="container"></div>

  <script type="module">

    const { DeckGL, TileLayer, BitmapLayer, COORDINATE_SYSTEM } = deck;

    let lat; let lon; let zoom; let center; let number;

    const url_hash = location.hash;
    let hash_last;

    if (url_hash === "") {
      lat = 37.300;
      lon = 137.800;
      zoom = 4.5;
      center = [];

    } else {
      console.log(url_hash);

      hash_last = url_hash.split("!");

      lat = Number(hash_last[1].split("/")[1]);
      lon = Number(hash_last[1].split("/")[0]);
      number = Number(hash_last[1].split("/")[2]);
      zoom = 8;

      center = [{
        "lat": lat,
        "lng": lon
      }]

    }

    /* ベースマップ */
    const tilelayer = new TileLayer({
      data: 'https://cyberjapandata.gsi.go.jp/xyz/blank/{z}/{x}/{y}.png',
      minZoom: 0,
      maxZoom: 19,

      renderSubLayers: props => {
        const {
          bbox: {
            west,
            south,
            east,
            north
          }
        } = props.tile;

        return new BitmapLayer(props, {
          data: null,
          image: props.data,
          bounds: [west, south, east, north]
        });
      }
    });

    let initialViewState = {
      latitude: lat,
      longitude: lon,
      zoom: zoom,
      minZoom: 4.5
    };

    const tooltip = (d) => {

      if (!d || !d.object) return null;
      let obj = d.object;

      let html_tr;

      html_tr = ["<table>", obj.properties.W05_004, "</table>"].join("\n");

      return {
        html: html_tr,
        style: {
          background: "rgba(0,0,0,0.7)",
          color: "#ffffff",
          width: "180px"
        }
      };

    };

    const deckgl = new deck.DeckGL({
      container: 'container',
      initialViewState,
      controller: true,
      getTooltip: tooltip,
      layers: [
        tilelayer,
        new deck.GeoJsonLayer({
          id: 'line',
          data: "./data/" + number + ".geojson",
          filled: true,
          lineWidthMinPixels: 5,
          getLineColor: [44, 169, 225],
          getLineWidth: 5,
          opacity: 0.8,
          pickable: true,
          autoHighlight: true,
          highlightColor: [232, 57, 41]
        })
      ]
    });

  </script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-MPP84V2NHB"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-MPP84V2NHB');
  </script>

</body>

</html>