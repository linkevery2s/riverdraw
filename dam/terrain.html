<!DOCTYPE HTML>
<html lang="ja">
<title>日本全国ダムマップ</title>

<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
  <meta charset="UTF-8" name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"
    integrity="sha512-GWzVrcGlo0TxTRvz9ttioyYJ+Wwk9Ck0G81D+eO63BaqHaJ3YZX9wuqjwgfcV/MrB2PhaVX9DkYVhbFpStnqpQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #000000;
      z-index: 1;
    }

    html {
      font-family: "Meiryo", "Hiragino Maru Gothic Pro", sans-serif;
    }

    .japan_side_menu {
      position: absolute;
      top: 50%;
      transform: translate(10px, -50%);
      z-index: 10000;
    }

    .japan_terrain,
    .japan_text {
      cursor: pointer;
      color: #000000;
      background: rgba(255, 255, 255, .8);
      border: 1px solid #000000;
      padding: .3em;
      border-radius: .5em;
    }

    .deck-tooltip {
      font-size: .7rem;
      width: 180px;
    }

    .button {
      cursor: pointer;
      color: #000000;
      background: rgba(255, 255, 255, .8);
      border: 1px solid #000000;
      padding: .3em;
      border-radius: .5em;
      border: 1px solid #000000;
    }

    .button2 {
      cursor: pointer;
      color: #000000;
      background: rgba(255, 255, 255, .8);
      border: 1px solid #000000;
      padding: .3em .4em .3em .4em;
      display: none;
      border-radius: .5em;
      border: 1px solid #000000;
    }

    @media screen and (min-width: 1024px) {
      .deck-tooltip {
        font-size: 1rem;
        width: 300px;
      }
    }
  </style>

</head>

<body>

  <!-- 日本の地形メニュー -->
  <span class="japan_side_menu">
    <div class="japan_text"><i class="fa-solid fa-lg fa-font"></i></div>
    <div class="button mt-3" id="button"><i class="fa-solid fa-lg fa-rotate"></i></div>
    <div class="button2 mt-3" id="button2"><i class="fa-solid fa-lg fa-stop"></i></div>
  </span>

  <script type="module">
    import { deck } from 'https://code4fukui.github.io/deck-es/deck.js';
    import { GsiTerrainLayer } from "https://code4fukui.github.io/deckgl-gsi-terrain-layer/index.js";

    // 地理院タイル
    const TERRAIN_IMAGE = 'https://cyberjapandata.gsi.go.jp/xyz/dem_png/{z}/{x}/{y}.png';
    const SURFACE_IMAGE = 'https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg';

    // RGB標高変換パラメータ
    const ELEVATION_DECODER = {
      scaler: 0.03,
      offset: 0
    };

    const layer = new GsiTerrainLayer({
      id: 'gsiTerrain',
      minZoom: 0,
      maxZoom: 20,
      elevationDecoder: ELEVATION_DECODER,
      elevationData: TERRAIN_IMAGE,
      texture: SURFACE_IMAGE,
    });

    const offices = new deck.ScenegraphLayer({
      id: 'scenegraph-layer',
      data: "./dam.json",
      pickable: true,
      scenegraph: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/BoxAnimated/glTF-Binary/BoxAnimated.glb',
      getPosition: d => [Number(d.lon), Number(d.lat)],
      getOrientation: d => [0, Math.random() * 180, 90],
      _animations: { '*': { speed: 5 } },
      sizeScale: 3000,
      _lighting: 'pbr'
    });

    const tooltip = (d) => {

      if (!d || !d.object) return null;
      let obj = d.object;

      let popup;

      console.log(obj);

      if (obj && obj.W01_001) {
        popup = "名称：" + obj.W01_001;
      }
      if (obj && obj.W01_013) {
        popup += "<br>住所：" + obj.W01_013;
      }
      if (obj && obj.W01_003) {
        popup += '<br>水系名：' + obj.W01_003;
      }

      if (obj && obj.W01_004) {
        popup += '<br>河川名：' + obj.W01_004;
      }

      if (obj && obj.W01_005) {

        if (obj.W01_005 == "1") {
          popup += '<br>ダム形式：アーチダム';
        }
        if (obj.W01_005 == "2") {
          popup += '<br>ダム形式：バットレスダム';
        }
        if (obj.W01_005 == "3") {
          popup += '<br>ダム形式：アースダム';
        }
        if (obj.W01_005 == "4") {
          popup += '<br>ダム形式：アスファルトフェイシングダム';
        }
        if (obj.W01_005 == "5") {
          popup += '<br>ダム形式：明日ダルとコアダム';
        }
        if (obj.W01_005 == "6") {
          popup += '<br>ダム形式：フローティングゲートダム（可動堰）';
        }
        if (obj.W01_005 == "7") {
          popup += '<br>ダム形式：重力式コンクリートダム';
        }
        if (obj.W01_005 == "8") {
          popup += '<br>ダム形式：重力式アーチダム';
        }
        if (obj.W01_005 == "9") {
          popup += '<br>ダム形式：重力式コンクリートダム・フィルダム複合ダム';
        }
        if (obj.W01_005 == "10") {
          popup += '<br>ダム形式：中空重力式コンクリートダム';
        }
        if (obj.W01_005 == "11") {
          popup += '<br>ダム形式：マルティプルアーチダム';
        }
        if (obj.W01_005 == "12") {
          popup += '<br>ダム形式：ロックフィルダム';
        }
        if (obj.W01_005 == "13") {
          popup += '<br>ダム形式：台形CSGダム';
        }

      }

      if (obj && obj.W01_006) {
        //popup += '<br>河川名：' + obj.W01_006;

        let motib = obj.W01_006.split(',');

        if (motib[0] == "1") {
          popup += '<br>使用目的：洪水調節、農地防災';
        }
        if (motib[0] == "2") {
          popup += '<br>使用目的：不特定用水、河川維持用水';
        }
        if (motib[0] == "3") {
          popup += '<br>使用目的：灌漑、特定(新規)灌漑用水';
        }
        if (motib[0] == "4") {
          popup += '<br>使用目的：上水道用水';
        }
        if (motib[0] == "5") {
          popup += '<br>使用目的：工業用水道用水';
        }
        if (motib[0] == "6") {
          popup += '<br>使用目的：発電';
        }
        if (motib[0] == "7") {
          popup += '<br>使用目的：消流雪用水';
        }
        if (motib[0] == "8") {
          popup += '<br>使用目的：レクリエーション';
        }


        for (let i = 1; i < motib.length; i++) {

          if (motib[i] == "1") {
            popup += '、農地防災';
          }
          if (motib[i] == "2") {
            popup += '、不特定用水、河川維持用水';
          }
          if (motib[i] == "3") {
            popup += '、灌漑、特定(新規)灌漑用水';
          }
          if (motib[i] == "4") {
            popup += '、上水道用水';
          }
          if (motib[i] == "5") {
            popup += '、工業用水道用水';
          }
          if (motib[i] == "6") {
            popup += '、発電';
          }
          if (motib[i] == "7") {
            popup += '、消流雪用水';
          }
          if (motib[i] == "8") {
            popup += '、レクリエーション';
          }

        }

      }

      if (obj && obj.W01_007) {
        popup += '<br>ダム規模（堤高）：' + obj.W01_007 + 'm';
      }

      if (obj && obj.W01_010) {
        popup += '<br>総貯水量：' + obj.W01_010 + '千m3';
      }

      if (obj && obj.W01_012) {
        popup += '<br>竣工年：' + obj.W01_012 + "年";
      }


      const html_tr = ["<table class='table_info'>", popup, "</table>"].join("\n");

      return {
        html: html_tr,
        style: {
          background: "rgba(255,255,255,0.9)",
          color: "#000000",
        }
      };
    };

    let lat; let lon; let zoom; let pitch; let bearing;

    const url_hash = location.hash;
    let hash_last;

    if (url_hash === "") {
      lat = 35.561;
      lon = 137.495;
      zoom = 7.0;
      pitch = 50;
      bearing = 0;

    } else {
      console.log(url_hash);

      hash_last = url_hash.split("!");

      lat = Number(hash_last[1].split("/")[0]);
      lon = Number(hash_last[1].split("/")[1]);
      zoom = Number(hash_last[1].split("/")[2]);
      pitch = Number(hash_last[1].split("/")[3]);
      bearing = Number(hash_last[1].split("/")[4]);

    }

    let initialViewState = {
      longitude: lon,
      latitude: lat,
      zoom: zoom,
      minZoom: 3,
      pitch: pitch,
      maxPitch: 85,
      bearing: bearing
    };

    const deckgl = new deck.Deck({
      initialViewState: initialViewState,
      onViewStateChange: ({ viewState }) => {

        initialViewState.longitude = viewState.longitude;
        initialViewState.latitude = viewState.latitude;
        initialViewState.zoom = viewState.zoom;
        initialViewState.pitch = viewState.pitch;
        initialViewState.bearing = viewState.bearing;

        zoom = Math.round(viewState.zoom * 10) / 10;
        lat = Math.round(viewState.latitude * 1000) / 1000;
        lon = Math.round(viewState.longitude * 1000) / 1000;
        pitch = Math.round(viewState.pitch * 10) / 10;
        bearing = Math.round(viewState.bearing * 100) / 100;

      },
      controller: {
        touchRotate: true
      },
      getTooltip: tooltip,
      layers: [
        layer, offices
      ]
    });

    let rotateCamera = () => {
      initialViewState = {
        ...initialViewState,
        bearing: initialViewState.bearing - 10,
        transitionDuration: 1000,
        transitionInterpolator: new deck.LinearInterpolator(['bearing']),
        onTransitionEnd: rotateCamera
      };
      deckgl.setProps({ initialViewState });
    };

    let stop = () => {
      initialViewState = {
        ...initialViewState,
        bearing: initialViewState.bearing - 0.01,
        transitionDuration: 0,
        transitionInterpolator: new deck.LinearInterpolator(['bearing']),
        onTransitionEnd: stop
      };
      deckgl.setProps({ initialViewState });

    };

    const japan_text = document.querySelector('.japan_text');

    japan_text.addEventListener('click', () => {
      location.href = "./text.html#!" + lat + "/" + lon + "/" + zoom + "/" + pitch + "/" + bearing;
    });

    const button = document.querySelector('.button');
    const button2 = document.querySelector('.button2');
    button.addEventListener('click', () => {
      rotateCamera();
      $("#button").hide();
      $("#button2").show();
    });

    button2.addEventListener('click', () => {
      stop();
      $("#button2").hide();
      $("#button").show();
    });

  </script>

</body>

</html>