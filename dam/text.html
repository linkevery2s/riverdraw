<!DOCTYPE HTML>
<html lang="ja">
<title>日本全国ダムマップ</title>

<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
  <meta charset="UTF-8" name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
  <script src='https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js'></script>
  <link href='https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css' rel='stylesheet' />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"
    integrity="sha512-GWzVrcGlo0TxTRvz9ttioyYJ+Wwk9Ck0G81D+eO63BaqHaJ3YZX9wuqjwgfcV/MrB2PhaVX9DkYVhbFpStnqpQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdn.tailwindcss.com"></script>

  <style type="text/css">
    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }

    html {
      font-family: "Meiryo", "Hiragino Maru Gothic Pro", sans-serif;
    }

    body {
      background: #000000;
    }

    #container {
      width: 100%;
      height: 100%;
      z-index: 10;
    }

    .japan_side_menu {
      position: absolute;
      top: 50%;
      transform: translate(10px, -50%);
      z-index: 10000;
    }

    .japan_terrain,
    .japan_text {
      cursor: pointer;
      color: #000000;
      background: rgba(255, 255, 255, .8);
      border: 1px solid #000000;
      padding: .3em;
      border-radius: .5em;
    }

    .deck-tooltip {
      font-size: .7rem;
      width: 180px;
    }

    @media screen and (min-width: 1024px) {
      .deck-tooltip {
        font-size: 1rem;
        width: 300px;
      }
    }
  </style>

</head>

<body>

  <div id="container"></div>

  <!-- 日本の地形メニュー -->
  <span class="japan_side_menu">
    <div class="japan_terrain"><i class="fa-solid fa-lg fa-image"></i></div>
  </span>

  <script type="module">
    const { DeckGL, GeoJsonLayer, ScenegraphLayer, ScatterplotLayer } = deck;

    let lat; let lon; let zoom; let pitch; let bearing;

    const url_hash = location.hash;
    let hash_last;

    if (url_hash === "") {
      lat = 35.666;
      lon = 139.779;
      zoom = 8.5;
      pitch = 50;
      bearing = 0;

    } else {
      console.log(url_hash);

      hash_last = url_hash.split("!");

      lat = Number(hash_last[1].split("/")[0]);
      lon = Number(hash_last[1].split("/")[1]);
      zoom = Number(hash_last[1].split("/")[2]);
      pitch = Number(hash_last[1].split("/")[3]);
      bearing = Number(hash_last[1].split("/")[4]);

    }

    const INITIAL_VIEW_STATE = {
      longitude: lon,
      latitude: lat,
      zoom: zoom,
      minZoom: 3,
      pitch: pitch,
      maxPitch: 85,
      bearing: bearing
    };

    const tooltip = (d) => {

      if (!d || !d.object) return null;
      let obj = d.object;

      let popup;

      console.log(obj);

      if (obj && obj.W01_001) {
        popup = "名称：" + obj.W01_001;
      }
      if (obj && obj.W01_013) {
        popup += "<br>住所：" + obj.W01_013;
      }
      if (obj && obj.W01_003) {
        popup += '<br>水系名：' + obj.W01_003;
      }

      if (obj && obj.W01_004) {
        popup += '<br>河川名：' + obj.W01_004;
      }

      if (obj && obj.W01_005) {

        if (obj.W01_005 == "1") {
          popup += '<br>ダム形式：アーチダム';
        }
        if (obj.W01_005 == "2") {
          popup += '<br>ダム形式：バットレスダム';
        }
        if (obj.W01_005 == "3") {
          popup += '<br>ダム形式：アースダム';
        }
        if (obj.W01_005 == "4") {
          popup += '<br>ダム形式：アスファルトフェイシングダム';
        }
        if (obj.W01_005 == "5") {
          popup += '<br>ダム形式：明日ダルとコアダム';
        }
        if (obj.W01_005 == "6") {
          popup += '<br>ダム形式：フローティングゲートダム（可動堰）';
        }
        if (obj.W01_005 == "7") {
          popup += '<br>ダム形式：重力式コンクリートダム';
        }
        if (obj.W01_005 == "8") {
          popup += '<br>ダム形式：重力式アーチダム';
        }
        if (obj.W01_005 == "9") {
          popup += '<br>ダム形式：重力式コンクリートダム・フィルダム複合ダム';
        }
        if (obj.W01_005 == "10") {
          popup += '<br>ダム形式：中空重力式コンクリートダム';
        }
        if (obj.W01_005 == "11") {
          popup += '<br>ダム形式：マルティプルアーチダム';
        }
        if (obj.W01_005 == "12") {
          popup += '<br>ダム形式：ロックフィルダム';
        }
        if (obj.W01_005 == "13") {
          popup += '<br>ダム形式：台形CSGダム';
        }

      }

      if (obj && obj.W01_006) {
        //popup += '<br>河川名：' + obj.W01_006;

        let motib = obj.W01_006.split(',');

        if (motib[0] == "1") {
          popup += '<br>使用目的：洪水調節、農地防災';
        }
        if (motib[0] == "2") {
          popup += '<br>使用目的：不特定用水、河川維持用水';
        }
        if (motib[0] == "3") {
          popup += '<br>使用目的：灌漑、特定(新規)灌漑用水';
        }
        if (motib[0] == "4") {
          popup += '<br>使用目的：上水道用水';
        }
        if (motib[0] == "5") {
          popup += '<br>使用目的：工業用水道用水';
        }
        if (motib[0] == "6") {
          popup += '<br>使用目的：発電';
        }
        if (motib[0] == "7") {
          popup += '<br>使用目的：消流雪用水';
        }
        if (motib[0] == "8") {
          popup += '<br>使用目的：レクリエーション';
        }


        for (let i = 1; i < motib.length; i++) {

          if (motib[i] == "1") {
            popup += '、農地防災';
          }
          if (motib[i] == "2") {
            popup += '、不特定用水、河川維持用水';
          }
          if (motib[i] == "3") {
            popup += '、灌漑、特定(新規)灌漑用水';
          }
          if (motib[i] == "4") {
            popup += '、上水道用水';
          }
          if (motib[i] == "5") {
            popup += '、工業用水道用水';
          }
          if (motib[i] == "6") {
            popup += '、発電';
          }
          if (motib[i] == "7") {
            popup += '、消流雪用水';
          }
          if (motib[i] == "8") {
            popup += '、レクリエーション';
          }

        }

      }

      if (obj && obj.W01_007) {
        popup += '<br>ダム規模（堤高）：' + obj.W01_007 + 'm';
      }

      if (obj && obj.W01_010) {
        popup += '<br>総貯水量：' + obj.W01_010 + '千m3';
      }

      if (obj && obj.W01_012) {
        popup += '<br>竣工年：' + obj.W01_012 + "年";
      }


      const html_tr = ["<table class='table_info'>", popup, "</table>"].join("\n");

      return {
        html: html_tr,
        style: {
          background: "rgba(255,255,255,0.9)",
          color: "#000000",
        }
      };
    };

    /*const prefectures = new GeoJsonLayer({
      id: 'prefectures',
      data: "./data/prefectures.geojson",
      filled: true,
      lineWidthMinPixels: 2,
      getFillColor: [255, 255, 255],
      getLineColor: [255, 255, 255],
      getLineWidth: 2,
      opacity: 0.02,
      pickable: true,
      autoHighlight: true,
      highlightColor: [230, 0, 51, 128]
    });*/

    const prefectures_line = new GeoJsonLayer({
      id: 'prefectures_line',
      data: "./prefectures_line.geojson",
      filled: true,
      lineWidthMinPixels: 2,
      getFillColor: [255, 255, 255],
      getLineColor: [255, 255, 255],
      getLineWidth: 2,
      opacity: 1,
      pickable: false
    });

    /*const offices = new ScenegraphLayer({
      id: 'scenegraph-layer',
      data: "./dam.json",
      pickable: true,
      scenegraph: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/BoxAnimated/glTF-Binary/BoxAnimated.glb',
      getPosition: d => [Number(d.lon), Number(d.lat)],
      getOrientation: d => [0, Math.random() * 180, 90],
      _animations: { '*': { speed: 5 } },
      sizeScale: 3000,
      _lighting: 'pbr'
    });*/

    const offices = new ScatterplotLayer({
      id: 'scatterplot-layer',
      data: "./dam.json",
      pickable: true,
      opacity: 0.8,
      stroked: true,
      filled: true,
      radiusScale: 6,
      radiusMinPixels: 10,
      radiusMaxPixels: 15,
      lineWidthMinPixels: 0,
      getPosition: d => [Number(d.lon), Number(d.lat)],
      getRadius: d => 30,
      getFillColor: d => [254, 242, 99]
    });

    const deckgl = new DeckGL({
      container: 'container',
      mapStyle: './basemap_tiri_photo.json',
      initialViewState: INITIAL_VIEW_STATE,
      onViewStateChange: ({ viewState }) => {

        zoom = Math.round(viewState.zoom * 10) / 10;
        lat = Math.round(viewState.latitude * 1000) / 1000;
        lon = Math.round(viewState.longitude * 1000) / 1000;
        pitch = Math.round(viewState.pitch * 10) / 10;
        bearing = Math.round(viewState.bearing * 100) / 100;

      },
      controller: {
        touchRotate: true
      },
      getTooltip: tooltip,
      layers: [
        prefectures_line, offices
      ]
    });

    const japan_terrain = document.querySelector('.japan_terrain');

    japan_terrain.addEventListener('click', () => {
      location.href = "./terrain.html#!" + lat + "/" + lon + "/" + zoom + "/" + pitch + "/" + bearing;
    });

  </script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-MPP84V2NHB"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-MPP84V2NHB');
  </script>

</body>

</html>